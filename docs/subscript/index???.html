<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sub Scribe</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="style.css">
        <link href="https://fonts.googleapis.com/css2?family=Recursive:slnt,wght,CASL,CRSV,MONO@-15,415,1,1,1&display=swap" rel="stylesheet">

</head>
<body>
    <div class="container sketchy-border">
          <div id="containerX"></div>

        <h1>subtractr</h1>

        <div class="chart-container">
            <div id="monthly-chart" class="chart"></div>
            <div id="annual-chart" class="chart"></div>
        </div>
        <div class="total-summary">
            <div id="total-cost"></div>
            <div id="total-monthly"></div>
            <div id="total-annual"></div>
        </div>

        <div class="table-container" id="subscription-table"></div>

        <button id="clear-data" style="margin-top: 20px;">Clear All Data</button>
    </div>

    <script>
        const STORAGE_KEY = "subscriptions";

        // Load data from localStorage
        function loadData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        }

        // Save data to localStorage
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // Gather data from the grid
        function gatherDataFromGrid() {
            const inputs = document.querySelectorAll('#subscription-table input, #subscription-table select');
            const subscriptions = [];

            inputs.forEach(input => {
                const index = input.dataset.index;
                const field = input.dataset.field;

                if (!subscriptions[index]) {
                    subscriptions[index] = {};
                }

                if (input.type === "checkbox") {
                    subscriptions[index][field] = input.checked;
                } else {
                    subscriptions[index][field] = input.value;
                }
            });

            return subscriptions;
        }

        // Save data whenever a field is changed
        function attachRealTimeSave() {
            const inputs = document.querySelectorAll('#subscription-table input, #subscription-table select');
            inputs.forEach(input => {
                input.addEventListener('input', handleSave); // Save on keystroke
                input.addEventListener('blur', handleSave); // Save on losing focus
            });
        }

        function handleSave() {
            const data = gatherDataFromGrid();
            saveData(data);
            renderCharts(data); // Optionally update charts in real time
        }

        // Create the input grid and populate with data
        function createInputGrid(data) {
            let gridHTML = `<div class="tableGridHeader">
                <div class="input-label">Active</div>
                <div class="input-label">Name</div>
                <div class="input-label">Cost</div>
                <div class="input-label">Period</div>
                <div class="input-label">Charge Date</div>
                <div class="input-label">Category</div>
                <div class="input-label">Account</div>
                <div class="input-label">Notes</div>
            </div>
            `;

            // BLASTD-ADDFIELD-1: add items into let gridHTML
            // BLASTD-ADDFIELD-2: add details to the for loop
            // What is the structure of the select

            for (let i = 0; i < 50; i++) {
                const sub = data[i] || {};
                gridHTML += `<div class="tableGrid">
                                                            <input type=x? "checked" : ""} data-index="${i}" data-field="active">

                    <input type="text" placeholder="Subscription Name" value="${sub.name || ''}" data-index="${i}" data-field="name">
                    <input type="number" placeholder="Cost" class="tabulation right" value="${sub.cost || ''}" data-index="${i}" data-field="cost">
                    <select data-index="${i}" data-field="period">
                        <option value="monthly" ${sub.period === "monthly" ? "selected" : ""}>Monthly</option>
                        <option value="annual" ${sub.period === "annual" ? "selected" : ""}>Annual</option>
                        <option value="other" ${sub.period === "other" ? "selected" : ""}>Other</option>
                    </select>
                    <input type="date" value="${sub.chargeDate || ''}" data-index="${i}" data-field="chargeDate">

<select id="categorySelect" data-index="${i}" data-field="category">
    <option value="entertainment" ${sub.category === "entertainment" ? "selected" : ""}>ðŸ”´ Entertainment</option>
    <option value="utilities" ${sub.category === "utilities" ? "selected" : ""}>ðŸ”µ Utilities</option>
    <option value="software" ${sub.category === "software" ? "selected" : ""}>ðŸŸ¢ Software</option>
    <option value="other" ${sub.category === "other" ? "selected" : ""}>ðŸŸ  Other</option>
    <option value="unknown" ${sub.category === "unknown" ? "selected" : ""}>ðŸŸ¤ Unknown</option>
    <option value="ending_service" ${sub.category === "ending_service" ? "selected" : ""}>âš« Ending Service</option>
    <option value="check" ${sub.category === "check" ? "selected" : ""}>ðŸŸ£ Check</option>
</select>

                    <select data-index="${i}" data-field="account">
                        <option value="me" ${sub.account === "me" ? "selected" : ""}>me</option>
                        <option value="not me" ${sub.account === "not me" ? "selected" : ""}>not me</option>
                    </select>
                    <input type="text" placeholder="Notes" value="${sub.notes || ''}" data-index="${i}" data-field="notes">
                </div>
                `;
            }

            $('#subscription-table').html(gridHTML);
            attachRealTimeSave(); // Attach real-time save to inputs
        }

        // Clear data and reset the grid
        function clearData() {
            localStorage.removeItem(STORAGE_KEY);
            createInputGrid([]); // Reset the grid
            renderCharts([]); // Clear charts
            alert("All data cleared!");
        }

        // Render Monthly and Annual Charts
        function renderCharts(data) {
            const monthlyData = [];
            const annualData = [];

                    // Map each category to a color
        const categoryColors = {
            entertainment: 'red',
            utilities: 'royalblue',
            software: 'green',
            other: 'orange',
            unknown: 'brown',
            ending_service: 'black',
            check: 'magenta'
            };

        data.forEach((item) => {
            if (item.cost && item.period) {
                const cost = parseFloat(item.cost);
                const chargeDate = new Date(item.chargeDate);
                const chargeName = item.name || 'Unnamed Charge';
                const category = item.category || 'Unknown';
                // Assign color/shape based on category
                const color = categoryColors[category] || 'black';


                if (item.period === "monthly") {
                    monthlyData.push({
                        x: chargeDate.getDate(), // Day of month
                        y: cost,
                        name: chargeName,
                        marker: {
                            radius: 12,    // 4Ã— bigger than default (4Ã—4 = 16)
                            fillColor: color  // Color by category
                        },
                        category: category,
                        tooltipDate: `${chargeDate.getDate()}${getOrdinalSuffix(chargeDate.getDate())} of month`
                    });
                } else if (item.period === "annual") {
                    const dayOfYear = Math.floor((chargeDate - new Date(chargeDate.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
                    annualData.push({
                        x: dayOfYear, // Day of year
                        y: cost,
                        name: chargeName,
                        marker: {
                            radius: 12,    // 4Ã— bigger than default (4Ã—4 = 16)
                            fillColor: color  // Color by category
                        },
                        category: category,
                        tooltipDate: `${chargeDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`
                    });
                }
            }
        });

        // Helper function to get ordinal suffix
        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

                Highcharts.chart('monthly-chart', {
                    chart: { type: 'scatter' },
                    title: { text: 'Monthly Subscription Costs' },
                    xAxis: { title: { text: 'Day of Month' }, min: 1, max: 31 },
                    yAxis: { title: { text: 'Cost ($)' }, min: 0 },
                    tooltip: {
                        useHTML: true,
                        pointFormat: '<b>{point.name}</b><br>Charge date: {point.tooltipDate}<br>Cost: ${point.y}<br>Category: {point.category}'
                    },
                    series: [{
                        name: 'Costs',
                        data: monthlyData
                    }]
                });

                Highcharts.chart('annual-chart', {
                    chart: { type: 'scatter' },
                    title: { text: 'Annual Subscription Costs' },
                    xAxis: { title: { text: 'Day of Year' }, min: 1, max: 366 },
                    yAxis: { title: { text: 'Cost ($)' }, min: 0 },
                    tooltip: {
                        useHTML: true,
                        pointFormat: '<b>{point.name}</b><br>Date: {point.tooltipDate}<br>Cost: ${point.y}<br>Category: {point.category}'
                    },
                    series: [{
                        name: 'Costs',
                        data: annualData
                    }]
                });
        }

        // Initialize the app
        function initializeApp() {
            const savedData = loadData();
            createInputGrid(savedData);
            renderCharts(savedData);

            $('#clear-data').on('click', clearData);
        }

        initializeApp();
    </script>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    const CATEGORY_CLASS_PREFIX = 'category-';

    // Function to apply a class to a select element
    const applyCategoryClass = (selectElement) => {
        const selectedValue = selectElement.value;

        // Remove any existing category-related classes
        selectElement.className = [...selectElement.classList]
            .filter(className => !className.startsWith(CATEGORY_CLASS_PREFIX))
            .join(' ');

        // Add the new class for the selected category
        if (selectedValue) {
            selectElement.classList.add(`${CATEGORY_CLASS_PREFIX}${selectedValue}`);
        }
    };

    // Attach event listeners to all category select elements
    const attachCategoryListeners = () => {
        document.querySelectorAll('#categorySelect').forEach(select => {
            select.addEventListener('change', (event) => {
                const selectElement = event.target;
                applyCategoryClass(selectElement);

                // Trigger the save handler to persist the change
                handleSave();
            });
        });
    };

    // Apply classes for all existing category select elements on page load
    const initializeCategoryClasses = () => {
        document.querySelectorAll('#categorySelect').forEach(select => {
            applyCategoryClass(select);
        });
    };

    // Reapply listeners and classes after the grid is created or updated
    const refreshCategoryListenersAndClasses = () => {
        initializeCategoryClasses();
        attachCategoryListeners();
    };

    // Inject the refresh into the existing app logic
    const originalCreateInputGrid = createInputGrid;
    createInputGrid = function(data) {
        originalCreateInputGrid(data);
        refreshCategoryListenersAndClasses();
    };

    // Run the initial setup
    initializeCategoryClasses();
    attachCategoryListeners();
});


    Highcharts.chart('containerX', {
      chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie'
      },
      title: {
        text: 'Browser market shares in January, 2018'
      },
      tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
      },
      plotOptions: {
        pie: {
          allowPointSelect: true,
          cursor: 'pointer',
          dataLabels: {
            enabled: true,
            format: '<b>{point.name}</b>: {point.percentage:.1f} %'
          }
        }
      },
      series: [{
        name: 'Brands',
        colorByPoint: true,
        data: [{
          name: 'Chrome',
          y: 61.41,
          sliced: true,
          selected: true
        }, {
          name: 'Internet Explorer',
          y: 11.84
        }, {
          name: 'Firefox',
          y: 10.85
        }, {
          name: 'Edge',
          y: 4.67
        }, {
          name: 'Safari',
          y: 4.18
        }, {
          name: 'Others',
          y: 7.05
        }]
      }]
    });

    </script>

</body>
</html>

<!-- FEATURES

general: simplify page style
+general: responsive
general: tab between monthly and annual
general: dark mode
power user: auto-update multiscreen
detector app - day interval detection
detector app - store values
detector app - auto merge value
detector app: nav or modal
detector app: add from CSV (merge with subtractor upload page)
feature: customized accounts selector (mgmt)
dataviz: category legend
dataviz: show total monthly / annual
dataviz: cross-highlighting between table and chart
dataviz: on monthly chart show any upcoming annual charges
dataviz: on annual chart show the amount of monthly costs by category
dataviz: pie chart of category spending
-dataviz: visually distinctive chart
-sharing: multi-device via firebase
-sharing: import export email
table: filtering (possibly filter chart too)
table: sorting
-table: color checkbox by category
-table: grey out lines for inactive
-feature: 2x2 chart of value / cost




 -->