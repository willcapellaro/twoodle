<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depth Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.11/pixi.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            width: 100vw;
        }

        /* Hide browser compatibility warning */
        #oldbrowser { display: none !important; }

        /* Main viewer container */
        #viewer-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #depthy-viewer {
            width: 100%;
            height: 100%;
            background: #111;
            position: relative;
        }

        #depthy-viewer canvas {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
        }

        /* Drop zone overlay */
        #drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #drop-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Control panel styles */
        .control-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            color: white;
            min-width: 200px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-panel.open {
            transform: translateX(0);
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .control-btn.active {
            background: rgba(59, 130, 246, 0.6);
            border-color: rgba(59, 130, 246, 0.8);
        }

        /* Fixed controls */
        .fixed-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 200;
            display: flex;
            gap: 8px;
        }

        .fixed-btn {
            width: 44px;
            height: 44px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fixed-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: rgba(255, 255, 255, 0.4);
        }

        /* Loading state */
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            color: white;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        /* Status indicator */
        .status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <!-- Main viewer container -->
    <div id="viewer-container" class="fit-mode">
        <div id="depthy-viewer"></div>
    </div>

    <!-- Drop overlay -->
    <div id="drop-overlay">
        <div class="flex flex-col items-center justify-center text-white text-center p-8 bg-black bg-opacity-50 rounded-lg border-2 border-dashed border-white">
            <i class="fas fa-cloud-upload-alt text-6xl mb-4"></i>
            <div class="text-xl mb-2">Drop color image + depth map (∂map)</div>
            <div class="text-sm opacity-70">
                Expecting: image.jpg + image-∂map.png
            </div>
        </div>
    </div>

    <!-- Fixed controls -->
    <div class="fixed-controls">
        <button class="fixed-btn" id="fit-fill-btn" title="Toggle Fit/Fill">
            <i class="fas fa-expand-arrows-alt"></i>
        </button>
        <button class="fixed-btn" id="upload-btn" title="Upload Images">
            <i class="fas fa-folder-open"></i>
        </button>
        <button class="fixed-btn" id="controls-btn" title="Open Controls">
            <i class="fas fa-sliders-h"></i>
        </button>
    </div>

    <!-- Control panel -->
    <div class="control-panel" id="control-panel">
        <div class="mb-4">
            <button class="control-btn w-full text-left mb-2" onclick="toggleControlPanel()">
                <i class="fas fa-times mr-2"></i>Close Panel
            </button>
        </div>

        <div class="control-group">
            <label class="control-label"><i class="fas fa-expand mr-2"></i>Depth Scale</label>
            <input type="range" class="slider" id="depth-scale" min="0" max="3" step="0.1" value="1">
            <div class="text-xs text-gray-400 mt-1">Current: <span id="depth-scale-value">1.0</span></div>
        </div>

        <div class="control-group">
            <label class="control-label"><i class="fas fa-crosshairs mr-2"></i>Focus Point</label>
            <input type="range" class="slider" id="depth-focus" min="0" max="1" step="0.01" value="0.5">
            <div class="text-xs text-gray-400 mt-1">Current: <span id="depth-focus-value">0.5</span></div>
        </div>

        <div class="control-group">
            <label class="control-label"><i class="fas fa-adjust mr-2"></i>Blur Size</label>
            <input type="range" class="slider" id="depth-blur" min="0" max="10" step="1" value="4">
            <div class="text-xs text-gray-400 mt-1">Current: <span id="depth-blur-value">4</span></div>
        </div>

        <div class="control-group">
            <label class="control-label"><i class="fas fa-hand-paper mr-2"></i>Mouse Sensitivity</label>
            <input type="range" class="slider" id="ease-factor" min="0.1" max="1" step="0.05" value="0.4">
            <div class="text-xs text-gray-400 mt-1">Current: <span id="ease-factor-value">0.4</span></div>
        </div>

        <div class="control-group">
            <label class="control-label"><i class="fas fa-eye mr-2"></i>Preview Mode</label>
            <input type="range" class="slider" id="depth-preview" min="0" max="1" step="0.1" value="0">
            <div class="text-xs text-gray-400 mt-1">Current: <span id="depth-preview-value">0</span></div>
        </div>

        <div class="control-group">
            <button class="control-btn active" id="animate-btn">
                <i class="fas fa-play mr-2"></i>Toggle Animation
            </button>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" style="display: none;">
        <div class="flex flex-col items-center">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <div>Loading depth viewer...</div>
        </div>
    </div>

    <!-- Status indicator -->
    <div class="status-indicator" id="status">
        <i class="fas fa-info-circle mr-1"></i>
        <span id="status-text">Ready - Drop images anywhere</span>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="file-input" multiple accept="image/*" style="display: none;">

    <!-- Load Depthy Engine -->
    <script src="scripts/pixi/DepthDisplacementFilter.js"></script>
    <script src="scripts/pixi/DepthPerspectiveFilter.js"></script>
    <script src="scripts/pixi/ColorMatrixFilter2.js"></script>
    <script src="scripts/pixi/utils.js"></script>
    <script src="scripts/classes/DepthyViewer.js"></script>

    <script>
        class DepthViewerApp {
            constructor() {
                this.depthyViewer = null;
                this.viewMode = 'fit';
                this.isDragging = false;
                this.dragStart = { x: 0, y: 0 };
                this.colorImage = null;
                this.depthMap = null;
                
                this.initializeControls();
                this.setupDropZone();
                this.loadExampleImages();
                this.updateStatus('Ready - Drop images anywhere');
            }

            initializeControls() {
                // Fit/Fill toggle
                document.getElementById('fit-fill-btn').addEventListener('click', () => {
                    this.toggleViewMode();
                });

                // Upload button
                document.getElementById('upload-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });

                // Controls panel toggle
                document.getElementById('controls-btn').addEventListener('click', () => {
                    this.toggleControlPanel();
                });

                // File input
                document.getElementById('file-input').addEventListener('change', (e) => {
                    this.handleFiles(Array.from(e.target.files));
                });

                // Control sliders with Tailwind styling
                this.setupSlider('depth-scale', 'depth-scale-value', () => this.updateDepthyOptions());
                this.setupSlider('depth-focus', 'depth-focus-value', () => this.updateDepthyOptions());
                this.setupSlider('depth-blur', 'depth-blur-value', () => this.updateDepthyOptions());
                this.setupSlider('ease-factor', 'ease-factor-value', () => this.updateDepthyOptions());
                this.setupSlider('depth-preview', 'depth-preview-value', () => this.updateDepthyOptions());

                // Animation toggle
                document.getElementById('animate-btn').addEventListener('click', () => {
                    this.toggleAnimation();
                });

                // Setup drag controls for depth interaction
                this.setupDragControls();
            }

            setupSlider(sliderId, valueId, callback) {
                const slider = document.getElementById(sliderId);
                const valueDisplay = document.getElementById(valueId);
                
                slider.addEventListener('input', (e) => {
                    valueDisplay.textContent = parseFloat(e.target.value).toFixed(2);
                    callback();
                });
            }

            setupDropZone() {
                const overlay = document.getElementById('drop-overlay');

                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    document.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });

                // Show overlay on drag enter
                document.addEventListener('dragenter', () => {
                    overlay.classList.add('active');
                });

                // Hide overlay on drag leave
                document.addEventListener('dragleave', (e) => {
                    if (!e.relatedTarget) {
                        overlay.classList.remove('active');
                    }
                });

                // Handle drop
                document.addEventListener('drop', (e) => {
                    overlay.classList.remove('active');
                    
                    const files = Array.from(e.dataTransfer.files);
                    this.handleFiles(files);
                });
            }

            async loadExampleImages() {
                try {
                    this.updateStatus('Loading example images...');
                    console.log('Attempting to load example images...');
                    
                    // Load images with better error handling
                    const colorImg = await this.loadImageFromUrl('images/test-images/glassbutt.jpeg');
                    console.log('Color image loaded:', colorImg.width, 'x', colorImg.height);
                    
                    const depthImg = await this.loadImageFromUrl('images/test-images/glassbutt-∂map.png');
                    console.log('Depth image loaded:', depthImg.width, 'x', depthImg.height);
                    
                    this.colorImage = colorImg;
                    this.depthMap = depthImg;
                    this.setupDepthyViewer(colorImg, depthImg);
                    this.updateStatus('Example loaded - Click and drag to interact');
                } catch (error) {
                    console.error('Could not load example images:', error);
                    this.updateStatus('Ready - Drop images anywhere (Example failed to load)');
                }
            }

            loadImageFromUrl(url) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = url;
                });
            }

            handleFiles(files) {
                if (files.length === 0) return;

                this.updateStatus('Processing files...');
                console.log('Processing files:', files.map(f => f.name));

                const colorFile = files.find(f => !f.name.includes('∂map'));
                const depthFile = files.find(f => f.name.includes('∂map'));

                console.log('Color file:', colorFile ? colorFile.name : 'none');
                console.log('Depth file:', depthFile ? depthFile.name : 'none');

                if (colorFile && depthFile) {
                    Promise.all([
                        this.loadImageFile(colorFile),
                        this.loadImageFile(depthFile)
                    ]).then(([colorImg, depthImg]) => {
                        console.log('Both images loaded successfully');
                        this.colorImage = colorImg;
                        this.depthMap = depthImg;
                        this.setupDepthyViewer(colorImg, depthImg);
                        this.updateStatus('Images loaded - Click and drag to interact');
                    }).catch(error => {
                        this.updateStatus('Error loading images: ' + error.message);
                        console.error('File loading error:', error);
                    });
                } else {
                    this.updateStatus('Please drop both color image and depth map (∂map)');
                }
            }

            loadImageFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            setupDepthyViewer(colorImage, depthImage) {
                try {
                    console.log('Setting up Depthy viewer...');
                    const container = document.getElementById('depthy-viewer');
                    container.innerHTML = '';

                    // Check if DepthyViewer is available
                    if (typeof DepthyViewer === 'undefined') {
                        throw new Error('DepthyViewer not loaded');
                    }

                    // Configure Depthy options - use correct API
                    const options = {
                        fit: this.viewMode === 'fit' ? 'contain' : 'cover',
                        hover: true, // Enable hover for now
                        depthScale: parseFloat(document.getElementById('depth-scale').value),
                        depthFocus: parseFloat(document.getElementById('depth-focus').value),
                        depthBlurSize: parseInt(document.getElementById('depth-blur').value),
                        depthPreview: parseFloat(document.getElementById('depth-preview').value),
                        easeFactor: parseFloat(document.getElementById('ease-factor').value),
                        quality: 4,
                        alwaysRender: true, // Force continuous rendering
                        size: {
                            width: window.innerWidth,
                            height: window.innerHeight
                        }
                    };

                    console.log('Creating DepthyViewer with options:', options);

                    // Create Depthy viewer with proper API
                    this.depthyViewer = new DepthyViewer(container, options);
                    
                    console.log('DepthyViewer created:', this.depthyViewer);
                    
                    // Wait a moment for initialization
                    setTimeout(() => {
                        console.log('Loading images...');
                        // Load images using Depthy's actual API
                        this.depthyViewer.setImage(colorImage);
                        this.depthyViewer.setDepthmap(depthImage);
                        
                        // Force a render
                        if (this.depthyViewer.render) {
                            this.depthyViewer.render();
                        }
                        
                        console.log('Images loaded, checking canvas...');
                        const canvas = container.querySelector('canvas');
                        if (canvas) {
                            console.log('Canvas found:', canvas.width, 'x', canvas.height);
                            canvas.style.display = 'block';
                            canvas.style.width = '100%';
                            canvas.style.height = '100%';
                        } else {
                            console.error('No canvas found in container');
                        }
                    }, 100);
                    
                    console.log('Depthy viewer setup complete');
                } catch (error) {
                    console.error('Error setting up Depthy viewer:', error);
                    this.updateStatus('Error setting up viewer: ' + error.message);
                }
            }

            setupDragControls() {
                const container = document.getElementById('depthy-viewer');
                let currentOffset = { x: 0, y: 0 };

                container.addEventListener('mousedown', (e) => {
                    this.isDragging = true;
                    this.dragStart = { x: e.clientX, y: e.clientY };
                    container.style.cursor = 'grabbing';
                    e.preventDefault();
                    
                    if (this.depthyViewer && this.depthyViewer.setOptions) {
                        this.depthyViewer.setOptions({
                            hover: true,
                            animate: false,
                            easeFactor: 0
                        });
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (!this.isDragging || !this.depthyViewer) return;

                    const containerRect = container.getBoundingClientRect();
                    const deltaX = (e.clientX - this.dragStart.x) / containerRect.width;
                    const deltaY = (e.clientY - this.dragStart.y) / containerRect.height;

                    const sensitivity = 2.0;
                    currentOffset.x = Math.max(-1, Math.min(1, -deltaX * sensitivity));
                    currentOffset.y = Math.max(-1, Math.min(1, -deltaY * sensitivity));
                    
                    this.simulateDepthyHover(container, currentOffset);
                });

                document.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    container.style.cursor = 'grab';
                    
                    if (this.depthyViewer && this.depthyViewer.setOptions) {
                        this.depthyViewer.setOptions({
                            easeFactor: parseFloat(document.getElementById('ease-factor').value)
                        });
                    }
                });

                container.style.cursor = 'grab';
            }

            simulateDepthyHover(container, offset) {
                if (!this.depthyViewer) return;
                
                const rect = container.getBoundingClientRect();
                const size = Math.min(rect.height, rect.width) * 0.9;
                
                const centerX = rect.width * 0.5;
                const centerY = rect.height * 0.5;
                const mouseX = centerX + (offset.x * size * 0.25);
                const mouseY = centerY + (offset.y * size * 0.25);
                
                container.dispatchEvent(new MouseEvent('mousemove', {
                    clientX: container.offsetLeft + mouseX,
                    clientY: container.offsetTop + mouseY,
                    bubbles: true
                }));
            }

            updateDepthyOptions() {
                if (!this.depthyViewer) return;

                const options = {
                    depthScale: parseFloat(document.getElementById('depth-scale').value),
                    depthFocus: parseFloat(document.getElementById('depth-focus').value),
                    depthBlurSize: parseInt(document.getElementById('depth-blur').value),
                    depthPreview: parseFloat(document.getElementById('depth-preview').value),
                    easeFactor: parseFloat(document.getElementById('ease-factor').value)
                };

                this.depthyViewer.setOptions(options);
            }

            toggleViewMode() {
                this.viewMode = this.viewMode === 'fit' ? 'fill' : 'fit';
                document.getElementById('viewer-container').className = this.viewMode + '-mode';
                
                const btn = document.getElementById('fit-fill-btn');
                const icon = btn.querySelector('i');
                
                if (this.viewMode === 'fill') {
                    icon.className = 'fas fa-compress-arrows-alt';
                    btn.title = 'Switch to Fit';
                } else {
                    icon.className = 'fas fa-expand-arrows-alt';
                    btn.title = 'Switch to Fill';
                }

                // Recreate viewer with new fit mode
                if (this.colorImage && this.depthMap) {
                    this.setupDepthyViewer(this.colorImage, this.depthMap);
                }
            }

            toggleControlPanel() {
                const panel = document.getElementById('control-panel');
                panel.classList.toggle('open');
            }

            toggleAnimation() {
                const btn = document.getElementById('animate-btn');
                const isAnimating = btn.classList.contains('active');
                
                btn.classList.toggle('active');
                
                if (this.depthyViewer) {
                    this.depthyViewer.setOptions({
                        animate: !isAnimating,
                        animateDuration: 3
                    });
                }
            }

            updateStatus(message) {
                document.getElementById('status-text').textContent = message;
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking dependencies...');
            console.log('PIXI available:', typeof PIXI !== 'undefined');
            console.log('DepthyViewer available:', typeof DepthyViewer !== 'undefined');
            console.log('jQuery available:', typeof $ !== 'undefined');
            console.log('Lodash available:', typeof _ !== 'undefined');
            
            if (typeof PIXI === 'undefined') {
                console.error('PIXI.js not loaded!');
                document.getElementById('status-text').textContent = 'Error: PIXI.js not loaded';
                return;
            }
            
            if (typeof DepthyViewer === 'undefined') {
                console.error('DepthyViewer not loaded!');
                document.getElementById('status-text').textContent = 'Error: DepthyViewer not loaded';
                return;
            }
            
            new DepthViewerApp();
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            // Depthy handles resize automatically
        });

        // Add close panel function for the close button
        function toggleControlPanel() {
            document.getElementById('control-panel').classList.toggle('open');
        }
    </script>
</body>
</html>