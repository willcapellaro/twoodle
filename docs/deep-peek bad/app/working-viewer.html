<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depth Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            width: 100vw;
        }

        /* Hide browser compatibility warning */
        #oldbrowser { display: none !important; }

        /* Main viewer container */
        #viewer-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #depthy-viewer {
            width: 100%;
            height: 100%;
        }

        /* Drop zone overlay */
        #drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #drop-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* UI Controls */
        .ui-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }

        .ui-button {
            width: 44px;
            height: 44px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .ui-button:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .ui-button.active {
            background: rgba(0, 122, 204, 0.8);
            border-color: #007acc;
        }

        /* Side panel */
        .side-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            padding: 20px;
            color: #fff;
        }

        .side-panel.open {
            transform: translateX(0);
        }

        .control-group {
            margin-bottom: 24px;
        }

        .control-label {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 8px;
            display: block;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #007acc;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Hidden file input */
        #file-input {
            display: none;
        }

        /* Fit/Fill modes */
        .fit-mode #depthy-viewer canvas {
            object-fit: contain;
        }

        .fill-mode #depthy-viewer canvas {
            object-fit: cover;
            width: 100vw !important;
            height: 100vh !important;
        }
    </style>
    
    <!-- CDN Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.11/pixi.min.js"></script>
</head>
<body>
    <!-- Main viewer container -->
    <div id="viewer-container" class="fit-mode">
        <div id="depthy-viewer"></div>
    </div>

    <!-- Drop overlay -->
    <div id="drop-overlay">
        <div class="flex flex-col items-center justify-center text-white text-center p-8 bg-black bg-opacity-50 rounded-lg border-2 border-dashed border-white">
            <i class="fas fa-cloud-upload-alt text-6xl mb-4"></i>
            <div class="text-xl mb-2">Drop color image + depth map (∂map)</div>
            <div class="text-sm opacity-70">
                Expecting: image.jpg + image-∂map.png
            </div>
        </div>
    </div>

    <!-- UI Controls -->
    <div class="ui-controls">
        <button class="ui-button" id="fit-fill-btn" title="Toggle Fit/Fill">
            <i class="fas fa-expand-arrows-alt"></i>
        </button>
        <button class="ui-button" id="upload-btn" title="Upload Images">
            <i class="fas fa-folder-open"></i>
        </button>
        <button class="ui-button" id="panel-btn" title="Controls">
            <i class="fas fa-sliders-h"></i>
        </button>
    </div>

    <!-- Side Panel -->
    <div class="side-panel" id="side-panel">
        <div class="control-group">
            <label class="control-label"><i class="fas fa-expand mr-2"></i>Depth Scale</label>
            <input type="range" class="slider" id="depth-scale" min="0" max="2" step="0.1" value="1">
        </div>
        
        <div class="control-group">
            <label class="control-label"><i class="fas fa-crosshairs mr-2"></i>Focus Distance</label>
            <input type="range" class="slider" id="focus-distance" min="0" max="1" step="0.01" value="0.5">
        </div>
        
        <div class="control-group">
            <label class="control-label"><i class="fas fa-hand-paper mr-2"></i>Ease Factor</label>
            <input type="range" class="slider" id="ease-factor" min="0" max="1" step="0.1" value="0.4">
        </div>

        <div class="control-group">
            <label class="control-label"><i class="fas fa-cogs mr-2"></i>Quality</label>
            <input type="range" class="slider" id="quality" min="1" max="5" value="3" step="1">
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="file-input" multiple accept="image/*">

    <!-- Load Depthy Engine -->
    <script src="scripts/pixi/DepthDisplacementFilter.js"></script>
    <script src="scripts/pixi/DepthPerspectiveFilter.js"></script>
    <script src="scripts/pixi/ColorMatrixFilter2.js"></script>
    <script src="scripts/pixi/utils.js"></script>
    <script src="scripts/classes/DepthyViewer.js"></script>

    <script>
        class DepthViewerApp {
            constructor() {
                this.depthyViewer = null;
                this.viewMode = 'fit';
                this.isDragging = false;
                this.dragStart = { x: 0, y: 0 };
                
                console.log('DepthViewerApp constructor called');
                
                this.initializeControls();
                this.setupDropZone();
                
                // Load example images immediately
                setTimeout(() => {
                    this.loadExampleImages();
                }, 100);
            }

            initializeControls() {
                // Fit/Fill toggle
                document.getElementById('fit-fill-btn').addEventListener('click', () => {
                    this.toggleViewMode();
                });

                // Upload button
                document.getElementById('upload-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });

                // Panel toggle
                document.getElementById('panel-btn').addEventListener('click', () => {
                    this.togglePanel();
                });

                // File input
                document.getElementById('file-input').addEventListener('change', (e) => {
                    this.handleFiles(Array.from(e.target.files));
                });

                // Control sliders
                document.getElementById('depth-scale').addEventListener('input', () => this.updateDepthyOptions());
                document.getElementById('focus-distance').addEventListener('input', () => this.updateDepthyOptions());
                document.getElementById('ease-factor').addEventListener('input', () => this.updateDepthyOptions());
                document.getElementById('quality').addEventListener('input', () => this.updateDepthyOptions());

                // Setup drag controls for depth interaction
                this.setupDragControls();
            }

            setupDropZone() {
                const overlay = document.getElementById('drop-overlay');

                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    document.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });

                // Show overlay on drag enter
                document.addEventListener('dragenter', () => {
                    overlay.classList.add('active');
                });

                // Hide overlay on drag leave
                document.addEventListener('dragleave', (e) => {
                    if (!e.relatedTarget) {
                        overlay.classList.remove('active');
                    }
                });

                // Handle drop
                document.addEventListener('drop', (e) => {
                    overlay.classList.remove('active');
                    
                    const files = Array.from(e.dataTransfer.files);
                    this.handleFiles(files);
                });
            }

            async loadExampleImages() {
                try {
                    console.log('Loading example images...');
                    // Load example images from samples folder
                    const colorImg = await this.loadImageFromUrl('samples/flowers-image.jpg');
                    const depthImg = await this.loadImageFromUrl('samples/flowers-depth.jpg');
                    
                    console.log('Example images loaded, setting up viewer...');
                    this.setupDepthyViewer(colorImg, depthImg);
                } catch (error) {
                    console.log('Could not load example images:', error);
                    // Try backup images
                    try {
                        const colorImg = await this.loadImageFromUrl('images/test-images/glassbutt.jpeg');
                        const depthImg = await this.loadImageFromUrl('images/test-images/glassbutt-∂map.png');
                        this.setupDepthyViewer(colorImg, depthImg);
                    } catch (backupError) {
                        console.log('Backup images also failed:', backupError);
                    }
                }
            }

            loadImageFromUrl(url) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = url;
                });
            }

            handleFiles(files) {
                if (files.length === 0) return;

                const colorFile = files.find(f => !f.name.includes('∂map'));
                const depthFile = files.find(f => f.name.includes('∂map'));

                if (colorFile && depthFile) {
                    Promise.all([
                        this.loadImageFile(colorFile),
                        this.loadImageFile(depthFile)
                    ]).then(([colorImg, depthImg]) => {
                        this.setupDepthyViewer(colorImg, depthImg);
                    });
                }
            }

            loadImageFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => resolve(img);
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            setupDepthyViewer(colorImage, depthImage) {
                console.log('Setting up Depthy viewer with images:', colorImage, depthImage);
                
                // Create new DepthyViewer instance
                const container = document.getElementById('depthy-viewer');
                container.innerHTML = '';

                // Configure Depthy options - use correct API
                const options = {
                    fit: this.viewMode === 'fit' ? 'contain' : 'cover',
                    hover: true, // Enable hover for now to test
                    depthScale: parseFloat(document.getElementById('depth-scale').value),
                    depthFocus: parseFloat(document.getElementById('focus-distance').value),
                    easeFactor: parseFloat(document.getElementById('ease-factor').value),
                    quality: parseInt(document.getElementById('quality').value),
                    alwaysRender: true,
                    size: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    }
                };

                console.log('Creating DepthyViewer with options:', options);

                // Create Depthy viewer with proper API
                this.depthyViewer = new DepthyViewer(container, options);
                
                console.log('DepthyViewer created, loading images...');
                
                // Load images using Depthy's actual API
                this.depthyViewer.setImage(colorImage);
                this.depthyViewer.setDepthmap(depthImage);
                
                console.log('Images set, viewer should be visible now');
                
                // Check if canvas was created
                setTimeout(() => {
                    const canvas = container.querySelector('canvas');
                    console.log('Canvas found:', canvas);
                    if (canvas) {
                        console.log('Canvas dimensions:', canvas.width, 'x', canvas.height);
                    }
                }, 100);
            }

            setupDragControls() {
                const container = document.getElementById('depthy-viewer');
                let currentOffset = { x: 0, y: 0 };

                container.addEventListener('mousedown', (e) => {
                    this.isDragging = true;
                    this.dragStart = { x: e.clientX, y: e.clientY };
                    container.style.cursor = 'grabbing';
                    e.preventDefault();
                    
                    // Temporarily enable hover and disable animation for responsive dragging
                    if (this.depthyViewer && this.depthyViewer.setOptions) {
                        this.depthyViewer.setOptions({
                            hover: true,
                            animate: false,
                            easeFactor: 0 // Immediate response
                        });
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (!this.isDragging || !this.depthyViewer) return;

                    const containerRect = container.getBoundingClientRect();
                    const deltaX = (e.clientX - this.dragStart.x) / containerRect.width;
                    const deltaY = (e.clientY - this.dragStart.y) / containerRect.height;

                    // Calculate new offset with sensitivity
                    const sensitivity = 2.0;
                    currentOffset.x = Math.max(-1, Math.min(1, -deltaX * sensitivity));
                    currentOffset.y = Math.max(-1, Math.min(1, -deltaY * sensitivity));
                    
                    // Create synthetic hover event that matches Depthy's expected format
                    this.simulateDepthyHover(container, currentOffset);
                });

                document.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    container.style.cursor = 'grab';
                    
                    // Restore original ease factor
                    if (this.depthyViewer && this.depthyViewer.setOptions) {
                        this.depthyViewer.setOptions({
                            easeFactor: parseFloat(document.getElementById('ease-factor').value)
                        });
                    }
                });

                container.style.cursor = 'grab';
            }

            simulateDepthyHover(container, offset) {
                if (!this.depthyViewer) return;
                
                // Get container dimensions
                const rect = container.getBoundingClientRect();
                const size = Math.min(rect.height, rect.width) * 0.9;
                
                // Convert offset to mouse position within container
                const centerX = rect.width * 0.5;
                const centerY = rect.height * 0.5;
                const mouseX = centerX + (offset.x * size * 0.25);
                const mouseY = centerY + (offset.y * size * 0.25);
                
                // Create event object that matches Depthy's onHover expectations
                const syntheticEvent = {
                    currentTarget: container,
                    pageX: container.offsetLeft + mouseX,
                    pageY: container.offsetTop + mouseY,
                    preventDefault: () => {},
                    stopPropagation: () => {}
                };
                
                // Dispatch the event to trigger Depthy's internal hover handler
                // This should update the depthOffset and trigger a render
                container.dispatchEvent(new MouseEvent('mousemove', {
                    clientX: syntheticEvent.pageX,
                    clientY: syntheticEvent.pageY,
                    bubbles: true
                }));
            }

            updateDepthyOptions() {
                if (!this.depthyViewer) return;

                const options = {
                    depthScale: parseFloat(document.getElementById('depth-scale').value),
                    depthFocus: parseFloat(document.getElementById('focus-distance').value),
                    easeFactor: parseFloat(document.getElementById('ease-factor').value),
                    quality: parseInt(document.getElementById('quality').value)
                };

                this.depthyViewer.setOptions(options);
            }

            toggleViewMode() {
                this.viewMode = this.viewMode === 'fit' ? 'fill' : 'fit';
                document.getElementById('viewer-container').className = this.viewMode + '-mode';
                
                const btn = document.getElementById('fit-fill-btn');
                const icon = btn.querySelector('i');
                
                if (this.viewMode === 'fill') {
                    icon.className = 'fas fa-compress-arrows-alt';
                    btn.title = 'Switch to Fit';
                } else {
                    icon.className = 'fas fa-expand-arrows-alt';
                    btn.title = 'Switch to Fill';
                }

                // Recreate viewer with new fit mode
                if (this.colorImage && this.depthMap) {
                    this.setupDepthyViewer(this.colorImage, this.depthMap);
                }
            }

            togglePanel() {
                const panel = document.getElementById('side-panel');
                const btn = document.getElementById('panel-btn');
                
                panel.classList.toggle('open');
                btn.classList.toggle('active');
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Check if all dependencies are loaded
            console.log('DOM loaded');
            console.log('PIXI available:', typeof PIXI !== 'undefined');
            console.log('DepthyViewer available:', typeof DepthyViewer !== 'undefined');
            
            if (typeof PIXI === 'undefined') {
                console.error('PIXI not loaded, waiting...');
                setTimeout(() => new DepthViewerApp(), 500);
            } else if (typeof DepthyViewer === 'undefined') {
                console.error('DepthyViewer not loaded, waiting...');
                setTimeout(() => new DepthViewerApp(), 500);
            } else {
                console.log('All dependencies loaded, starting app...');
                new DepthViewerApp();
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            // Depthy handles resize automatically
        });
    </script>
</body>
</html>